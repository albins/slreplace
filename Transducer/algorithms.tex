%!TEX root = main.tex

\section{Algorithmic results}
\label{sec:algo}


\subsection{A generic decision procedure based on recognisable relations}

In this section, let us assume an $\straightline[\transet]$ formula $\varphi \wedge \psi$.
We will present a generic decision procedure for $\straightline[\transet]$ based on recognisable relations.

\begin{definition}[Recognisable relation]
	Given a finite alphabet $\Sigma$, a $k$-ary relation $R\subseteq \Sigma^*\times \cdots\times \Sigma^*$ is \emph{recognisable}  if $R=\bigcup_{i=1}^n L^{(i)}_1\times \cdots\times L^{(i)}_k$ where $L^{(i)}_j$ is regular for each $j\in [k]$.
%
%	[One can certainly generalise this to $n$-ary relations. ]
\end{definition}

For a recognisable relation $R=\bigcup_{i=1}^n L^{(i)}_1\times \cdots\times L^{(i)}_k$, we will use a collection of tuples $(\Aut^{(i)}_1, \cdots, \Aut^{(i)}_k)_{1 \le i \le n}$ to represent $R$, where each $\Aut^{(i)}_j$ is an NFA.  

Let $\Transducer$ be a transducer from $\transet$, say with $k$ parameters (possibly $k=0$), and $\Aut$ be an NFA. Then the \emph{preimage} of $\Aut$ w.r.t. $\Transducer$, denoted by $\Pre_\Transducer(\Aut)$, is the set of tuples $(w, w_1,\cdots, w_k)$ such that there is an accepting run of $\Transducer$ on $w$, equipped with the parameters $w_1,\cdots, w_k$, which produces an output $w'$ belonging to $\Lang(\Aut)$.

\begin{theorem}\label{thm-generic-dec}
Suppose that $\transet$ satisfies that for each $\Transducer \in \transet$ and NFA $\Aut$, $\Pre_\Transducer(\Aut)$ is a recognisable relation and a representation of  $\Pre_\Transducer(\Aut)$ can be computed effectively where each NFA is of size at most $f(|\Transducer|, |\Aut|)$. Then for an $\straightline[\transet]$ formula $\varphi \wedge \psi$, its satisfiability can be decided in nondeterministic $O((K+2)^D f^{(D)}(|\varphi|, |\psi|))$ space, where $K$ is the maximum number of parameters of $\Transducer \in \transet$, $D$ is the maximum length of the paths in $\cG(\varphi)$,  and $f^{(i)}(j, k)$ is defined as follows: $f^{(1)}(j,k)= f(j, k)$ and $f^{(i+1)}(j, k) = f(j, f^{(i)}(j,k))$.
\end{theorem}

\begin{proof}
Let $\varphi \wedge \psi$ be an $\straightline[\transet]$ formula. 

We utilise the dependency graph $\cG(\varphi)$ and compute \emph{nondeterministically} a collection of atomic regular constraints $\cE(x)$ over the alphabet $\Sigma$ for each variable $x$, in a top-down manner.

%Notice that $\cE(x)$ is represented succinctly as a set of pairs $(S, P)$, where $S=(Q, \delta)$ is a transition graph and $P \subseteq Q \times Q$. The intention of $(S, P)$ is to represent succinctly the collection of the atomic regular constraints containing $(\Sigma, Q, \delta, q, \{q'\})$ for each $(q,q') \in P$, where $q$ is the initial state and $\{q'\}$ is the set of final states.

Initially, let $\cG_0:= \cG(\varphi)$. Moreover, for each variable $x$, we define $\cE_0(x)$ as follows: Let $x \in \Aut_1 \wedge \cdots \wedge x \in \Aut_n$ be the conjunction of all the atomic regular constraints related to $x$ in $\psi$. 
%For each $i \in [n]$, let $\Aut_i=(\Sigma, Q_i, \delta_i, q_{0,i}, F_i)$.
% We nondeterministically choose $q_i \in F_i$ and set $\cE_0(x):=  \left\{((Q_i, \delta_i), \{(q_{0,i}, q_i)\}) \mid i \in [n] \right\}$.
 We set $\cE_0(x):=  \left\{\Aut_1,\cdots, \Aut_n \right\}$.

We begin with $i:= 0$ and repeat the following procedure until we reach some $i$ where $\cG_i$ is an empty graph, i.e. a graph without edges.
Note that $\cG_0$ was defined above.
\begin{enumerate}
\item Select a vertex $x$ of $\cG_i$ such that $x$ has no predecessors  and has $k+1$ successors (possibly $k=0$) via edges $(x, (\Transducer, 0), y_0)$ and $(x, (\Transducer, j), y_j)$ with $j \in [k]$ in $\cG_i$.  Suppose $\cE_i(x)=\{\Aut_1, \cdots, \Aut_n\}$, where for each $j \in [n]$, $\Aut_j = (\Sigma, Q_j, q_{0,j}, F_j, \delta_j)$. Moreover, for each $j \in [n]$, let $\Pre_{\Transducer}(\Aut_j)$ be represented by $(\Aut^{(j')}_{j, 0}, \cdots, \Aut^{(j')}_{j, k})_{ j'  \in [m_j]}$.
Then $\cE_{i+1}(z)$ for $z \in  \{y_0,\cdots, y_k\}$ and $\cG_{i+1}$ are computed as follows:
\begin{enumerate}
\item For each $j \in [n]$, nondeterministically choose a tuple $(\Aut^{(r_j)}_{j, 0}, \cdots, \Aut^{(r_j)}_{j, k})$ (where $r_j \in [m_j]$).
%
\item For each $z \in \{y_0,\cdots, y_k\}$, let
\[
    \cE_{i+1}(z):= \cE_{i}(z) \cup \left\{\Aut^{(r_j)}_{j, j'} \mid  j \in [n], j' \in [k], z = y_{j'} \right\}.
\]
In addition, for each vertex $z'  {\notin} \{y_0,\cdots, y_k\}$, let $\cE_{i+1}(z') := \cE_i(z')$.
%We set $\cE_{i+1}(x) = \emptyset$.
%
\item Let $\cG_{i+1}:= \cG_i \backslash \{(x, (\Transducer, j), y_j) \mid j \in \{0\} \cup [k]\}$.
\end{enumerate}
%
\item Let $i: = i+1$.
\end{enumerate}

For each variable $x$, let $\cE(x)$ denote the set $\cE_i(x)$ after exiting the above loop.

Therefore, we can decide the satisfiability of $\varphi \wedge \psi$ by first nondeterministically constructing the sets $\cE(x)$ for $x \in \vars(\varphi \wedge \psi)$, then guessing an accepting run of the product of NFAs in $\cE(x)$ for each $x \in \vars(\varphi \wedge \psi)$.

\paragraph{Complexity analysis.} For each $i$, let $M_i$ be the maximum number of elements in $\cE_i(x)$ for $x  \in \vars(\varphi \wedge \psi)$ and $N_i$ be the maximum size of NFAs in $\bigcup \limits_{x \in \vars(\varphi \wedge \psi)} \cE_i(x)$. Then we have $M_{i+1} \le M_i + (K+1)M_i = (K+2) M_i$. Moreover,  because each $T \in \transet$ occurring in $\varphi$ satisfies that $|T| \le |\varphi|$, we have $N_{i+1} \le f(|\varphi|, N_i)$. Therefore, we conclude that for each $x \in \vars(\varphi \wedge \psi)$, $\cE(x)$ contains at most $(K+2)^D$ elements and each NFA in $\cE(x)$ is of size at most $f^{(D)}(|\varphi|, |\psi|)$. Moreover, from the fact that guessing an accepting run of an NFA can be fulfilled in nondeterministic logarithmic space, we conclude that the aforementioned decision procedure is in nondeterministic $O((K+2)^D f^{(D)}(|\varphi|, |\psi|))$ space.
\end{proof}

\subsection{Two-way}

%Let $\Transducer$ be a 2PT with $k$ parameters $y_1,\cdots, y_k$ and $\Aut$ be an NFA. Then the \emph{preimage} of $\Aut$ w.r.t. $\Transducer$, denoted by $\Pre_\Transducer(\Aut)$, is the set of tuples $(w, w_1,\cdots, w_k)$ such that there is an accepting run of $\Transducer$ on $w$ producing an output $w' \in \Lang(\Aut)$, equipped with the parameters $w_1,\cdots, w_k$.


\begin{lemma}\label{lem-2pt}
Let $\Transducer$ be a 2PT and $\Aut$ be an NFA. Then $\Pre_\Transducer(\Aut)$ is a recognisable relation and a representation of $\Pre_\Transducer(\Aut)$ can be constructed effectively from $\Transducer$ and $\Aut$ where each NFA is of size at most $2^{O(|\Transducer||\Aut|\log (|\Transducer||\Aut|))}$.
\end{lemma}

\begin{proof}
Let $\Transducer=(X, Q, q_0, F, \delta)$ be a 2PT where $X = \{x_1,\cdots, x_k\}$ and $\Aut=(Q', q'_0, F', \delta')$ be an NFA.

We first introduce some notations.

For $S \subseteq Q' \times Q'$, let $\Aut[S]$ denote the product of $\Aut(q'_1, \{q'_2\})$ for $(q'_1,q'_2) \in S$. 

Suppose $S_{x_1}, \cdots, S_{x_k} \subseteq Q \times Q$. Then $\cB_{\Transducer, \Aut, S_{x_1}, \cdots, S_{x_k}}$ is the NFA adapted from $\Transducer$  by simulating a run of $\Aut$ on the output (instead of materialising the output), where $S_{x_1}$ is used to jump over $y_1$ when $x_1$ is the output of a transition of $\Transducer$, similarly for $S_{x_2}, \cdots, S_{x_k}$. More precisely, $\cB_{\Transducer, \Aut, S_{x_1}, \cdots, S_{x_k}}$ is computed by the following two-step procedure:
\begin{enumerate} 
\item Construct a 2NFA $\Aut'' = (Q'', q''_{0}, F'', \delta'')$, where $Q'' = Q \times Q'$, $q''_0 = (q_0, q'_0)$, $F'' \subseteq F \times F'$, and $\delta''$ comprises the tuples $((q_1, q'_1), a, dir, (q_2, q'_2))$ such that either there is $b \in \Sigma$ satisfying $(q_1, a, dir, q_2, b) \in \delta$ and $(q'_1, b, q'_2) \in \delta'$, or there is $x_i \in X$ satisfying $(q_1, a, dir, q_2, x_i) \in \delta$  and $(q'_1, q'_2) \in S_{x_i}$.
\item Transform $\Aut''$ into the equivalent NFA.
\end{enumerate} 
Note that the size of $\cB_{\Transducer, \Aut, S_{x_1}, \cdots, S_{x_k}}$ is at most $(|T||\Aut|)=2^{O(|T||\Aut| \log(|T||\Aut|))}$.

\paragraph{Claim.} For each tuple of words $(w, w_1,\cdots, w_k)$, $(w, w_1,\cdots, w_k) \in \Pre_\Transducer(\Aut)$ iff there are $S_{x_1}, \cdots, S_{x_k} \subseteq Q' \times Q'$ such that $w \in \Lang(\cB_{\Transducer, S_{x_1}, \cdots, S_{x_k}})$ and $w_i \in \Lang(\Aut[S_{x_i}])$ for each $i \in [k]$.

\medskip

Therefore, $\Pre_\Transducer(\Aut)$ is a union of
\[\Lang(\cB_{\Transducer, S_{x_1}, \cdots, S_{x_k}}) \times \Lang(\Aut[S_{x_1}]) \times \cdots  \times \Lang(\Aut[S_{x_k}]), \]
for $S_{x_1}, \cdots, S_{x_k} \subseteq Q' \times Q'$. 

We conclude that $\Pre_\Transducer(\Aut)$ is a recognisable relation and a representation of $\Pre_\Transducer(\Aut)$ can be constructed effectively from $\Transducer$ and $\Aut$ where each NFA is of size at most $2^{O(|\Transducer||\Aut|\log (|\Transducer||\Aut|))}$.
\end{proof}

From Lemma~\ref{lem-2pt} and Theorem~\ref{thm-generic-dec}, we deduce the following result.
%
\begin{corollary}
Given an $\straightline[\twpt]$ formula $\varphi \wedge \psi$, its satisfiability can be decided in n-$\expspace$, where $n$ is the maximum length of paths in $\cG(\varphi)$. 
\end{corollary}


\subsection{One-way}


\begin{lemma}\label{lem-1pt}
Let $\Transducer$ be a 1PT and $\Aut$ be an NFA. Then $\Pre_\Transducer(\Aut)$ is a recognisable relation and a representation of $\Pre_\Transducer(\Aut)$ can be constructed effectively from $\Transducer$ and $\Aut$ where each NFA is of size at most $|\Transducer||\Aut|$.
\end{lemma}

From Lemma~\ref{lem-1pt} and Theorem~\ref{thm-generic-dec}, we deduce the following result.
%
\begin{corollary}
Given an $\straightline[\owpt]$ formula $\varphi \wedge \psi$, its satisfiability can be decided in $\expspace$. 
\end{corollary}

reversal-bounded transducers ?

