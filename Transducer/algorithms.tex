%!TEX root = main.tex

%\section{Algorithmic results}



\section{A generic decision procedure with recognisable relations} \label{sec:algo}

In this section,  we present a generic decision procedure for $\straightline[\transet]$ based on the notion of recognisable relations. We assume an $\straightline[\transet]$ formula $\varphi \wedge \psi$ where $\varphi$ and $\psi$ are relational and  regular constraints respectively.

\begin{definition}[Recognisable relation]
	Given a finite alphabet $\Sigma$, a $k$-ary relation $R\subseteq \Sigma^*\times \cdots\times \Sigma^*$ is \emph{recognisable}  if $R=\bigcup_{i=1}^n L^{(i)}_1\times \cdots\times L^{(i)}_k$ where $L^{(i)}_j$ is regular for each $j\in [k]$.
%
%	[One can certainly generalise this to $n$-ary relations. ]
\end{definition}


For a recognisable relation $R$,  a \emph{representation} of $R$ is a collection of tuples $(\Aut^{(i)}_1, \cdots, \Aut^{(i)}_k)_{i\in [n]}$  such that 
$R = \bigcup_{i=1}^n \Lang(\Aut^{(i)}_1) \times \cdots\times \Lang(\Aut^{(i)}_k)$, where each $\Aut^{(i)}_j$ is an NFA. The numbers $k, n$ are called the \emph{dimension} and \emph{width}  of the representation respectively, and each NFA $\Aut^{(i)}_j$ is called an \emph{atom} of the representation.
Furthermore, to obtain tight space complexity bounds (in some cases), we notice that, 
suppose $\Aut^{(i)}_j=(\controls^{(i)}_j, q^{(i)}_{0,j}, \transrel^{(i)}_j, \finals^{(i)}_j)$ for $i \in [n]$ and $j \in [k]$, it holds that $\Lang(\Aut^{(i)}_j) = \bigcup \limits_{q \in \finals^{(i)}_j} \Lang(\Aut^{(i)}_j(q^{(i)}_{0,j}, \{q\}))$. Furthermore,  $\Aut^{(i)}_j(q^{(i)}_{0, j}, \{q^{(i)}_j\})$ can be decoupled as a pair $((\controls^{(i)}_j,  \transrel^{(i)}_j), \{(q^{(i)}_{0,j}, q^{(i)}_j)\})$, 
%
%\footnote{Each representation can be turned into one satisfying the requirement as follows: Suppose $\Aut^{(i)}_j=(\controls^{(i)}_j, q^{(i)}_{0,j}, \transrel^{(i)}_j, \finals^{(i)}_j)$ for $i \in [n]$ and $j \in [k]$. Since $\Lang(\Aut^{(i)}_j) = \bigcup \limits_{q \in \finals^{(i)}_j} \Lang(\Aut^{(i)}_j(q^{(i)}_{0,j}, \{q\}))$, we have $R = \bigcup \limits_{i=1}^n \bigcup \limits_{\forall j \in [k]. q^{(i)}_j \in \finals^{(i)}_j } \Lang(\Aut^{(i)}_1(q^{(i)}_{0, 1}, \{q^{(i)}_1\})) \times \ldots \times \Lang(\Aut^{(i)}_k(q^{(i)}_{0, k}, \{q^{(i)}_k\}))$. Each NFA $\Aut^{(i)}_j(q^{(i)}_{0, j}, \{q^{(i)}_j\})$ can be encoded as a pair $((\controls^{(i)}_j,  \transrel^{(i)}_j), \{(q^{(i)}_{0,j}, q^{(i)}_j)\})$.} 
%
%
and thus each $\Aut^{(i)}_j$ can be \emph{succinctly} encoded in the form of $((\controls, \transrel), S)$, where $(\controls, \transrel)$ is a transition graph and $S \subseteq \controls \times \controls$ is a set of ``initial-final" pair of states, such that $\Lang(\Aut^{(i)}_j) = \bigcup \limits_{(q,q') \in S} \Lang(\cB_{q,q'})$ \tl{previously, it was $\bigcap$, but I guess it was a typo?} with $\cB_{q,q'} = (\controls, q, \transrel, \{q'\})$. 
\tl{this is generally correct, but specifically, there is only one initial state for the automata, so $S$ could be made more precisely?}

It follows that 
%we do the following transformation:
%
%Each representation can be turned into one satisfying the requirement as follows: 
%we have 
\begin{align*}
R  & =   \bigcup_{i=1}^n \prod_{j=1}^k \Lang(\Aut^{(i)}_j) \\
& =   \bigcup_{i=1}^n  \prod_{j=1}^k \bigcup \limits_{q_j \in \finals^{(i)}_j} \Lang(\Aut^{(i)}_j(q^{(i)}_{0,j}, \{q_j\}))\\
&=	\bigcup \limits_{i=1}^n \bigcup \limits_{\forall j \in [k]. q^{(i)}_j \in \finals^{(i)}_j } \prod_{j=1}^k \Lang(\Aut^{(i)}_j(q^{(i)}_{0, j}, \{q^{(i)}_j\})) 
%\times \ldots \times \Lang(\Aut^{(i)}_k(q^{(i)}_{0, k}, \{q^{(i)}_k\})).
\end{align*}
%
%
%that each atom $\Aut^{(i)}_j$ is \emph{succinctly} encoded into a pair $((\controls, \transrel), S)$, where $(\controls, \transrel)$ is a transition graph and $S \subseteq \controls \times \controls$, such that $\Lang(\Aut^{(i)}_j) = \bigcap \limits_{(q,q') \in S} \Lang(\cB_{q,q'})$ with $\cB_{q,q'} = (\controls, q, \transrel, \{q'\})$. 
%
The size of an automaton of the form $((\controls, \transrel), S)$ is defined as $|\controls|$, and thus we define the 
the \emph{atom size} of $T$, written $|T|$, \tl{check} to be $\max\{|Q_{j}^{(i)}|: i\in [n], j\in[k]\}$.

%The maximum size of (the succinct encodings of) the atoms of a representation is called the \emph{atom size} of the representation. 
%=======
%Furthermore, in order to get better space complexity upper bounds (in some cases), we require\footnote{Each representation can be turned into one satisfying the requirement as follows: Suppose $\Aut^{(i)}_j=(\controls^{(i)}_j, q^{(i)}_{0,j}, \finals^{(i)}_j, \transrel^{(i)}_j)$ for $i \in [n]$ and $j \in [k]$. Since $\Lang(\Aut^{(i)}_j) = \bigcup \limits_{q \in \finals^{(i)}_j} \Lang(\Aut^{(i)}_j(q^{(i)}_{0,j}, \{q\}))$, we have $R = \bigcup \limits_{i=1}^n \bigcup \limits_{\forall j \in [k]. q^{(i)}_j \in \finals^{(i)}_j } \Lang(\Aut^{(i)}_1(q^{(i)}_{0, 1}, \{q^{(i)}_1\})) \times \ldots \times \Lang(\Aut^{(i)}_k(q^{(i)}_{0, k}, \{q^{(i)}_k\}))$. Each NFA $\Aut^{(i)}_j(q^{(i)}_{0, j}, \{q^{(i)}_j\})$ can be encoded as a pair $((\controls^{(i)}_j,  \transrel^{(i)}_j), \{(q^{(i)}_{0,j}, q^{(i)}_j)\})$.} 
%%
%that each atom $\Aut^{(i)}_j$ is \emph{succinctly} encoded into a pair $((\controls, \transrel), S)$, where $(\controls, \transrel)$ is a transition graph and $S \subseteq \controls \times \controls$, such that $\Lang(\Aut^{(i)}_j) = \bigcap \limits_{(q,q') \in S} \Lang(\cB_{q,q'})$ with $\cB_{q,q'} = (\controls, q, \{q'\}, \transrel)$. The size of $((\controls, \transrel), S)$ is defined as $|\controls|$. The maximum size of (the succinct encodings of) the atoms of a representation is called the \emph{atom size} of the representation. 
%>>>>>>> 104e69ae6204529f3ecd049a9405556039c70921

%it is the product of $\cB(q, \{q'\})$ for an NFA $\cB=(\controls, q_0, \transrel, \finals)$ and $(q, q') \in S$ with $S \subseteq Q \times Q$, then we encode $\Aut^{(i)}_j$ \emph{succinctly} as a pair $(\transrel, S)$. Note that the \emph{size} of this succinct encoding is $|\transrel|+|S|$, which is polynomial in $|\controls|$, while $|\Aut^{(i)}_j|$ is exponential in $|S|$.

\medskip

Let $\Transducer$ be a parametric transducer %from $\transet$ 
with $k$ parameters ($k\geq 0$), and $\Aut$ be an NFA. The \emph{pre-image} of $\Aut$ with respect to $\Transducer$, denoted by $\Pre_\Transducer(\Aut)$, is the set of tuples $(w, w_1,\cdots, w_k)$ such that there is an accepting run of $\Transducer$ on $w$ with output $w'\in \Lang(\Aut)$ when equipped with the parameters $w_1,\cdots, w_k$. 


We define $f^{\langle n \rangle}(j, k)$ ($n\geq 1$) as $f^{\langle 1 \rangle}(j,k)= f(j, k)$ and $f^{\langle n+1 \rangle }(j, k) = f(j, f^{\langle n \rangle}(j,k))$. 

%For instance, if $f(j, k) = j*k$, then $f^{\langle 2 \rangle}(j, k)= f(j, f^{\langle 1 \rangle}(j, k)) = j * f(j, k)= j^2k$.

\begin{theorem}\label{thm-generic-dec}
Suppose that %$\transet$ satisfies that 
for each $\Transducer \in \transet$ and NFA $\Aut$, $\Pre_\Transducer(\Aut)$ is a recognisable relation.  Moreover, a representation of $\Pre_\Transducer(\Aut)$, whose atom size is bounded by $f(|\Transducer|, |\Aut|)$ for some monotone function $f$, can be determined effectively. Then the satisfiability of a given $\straightline[\transet]$ formula $\varphi \wedge \psi$ can be decided in \emph{nondeterministic} 
%\tl{why not remove  nondeterministic?} 
$O((\rcdim(\varphi)+2)^{\rcdep(\varphi)} (f^{\langle \rcdep(\varphi) \rangle}(|\varphi|, |\psi|))^2 \log f^{\langle \rcdep(\varphi) \rangle}(|\varphi|, |\psi|))$ space.
%, where $K$ is the maximum number of parameters of 
%transducers appearing in the constraints, 
%$D$ is the maximum length of the paths in $\cG(\varphi)$.
\end{theorem}

\begin{proof}
Let $\varphi \wedge \psi$ be an $\straightline[\transet]$ formula. 

We first \emph{nondeterministically} compute $\cE(x)$, a collection of succinctly encoded NFAs over the alphabet $\Sigma$, for each variable $x \in \vars(\varphi \wedge \psi)$, by utilising the dependency graph $\cG(\varphi)$. 
% , in a top-down manner.

Initially, let $\cG_0 := \cG(\varphi)$, and  
we construct $\cE_0(x)$ as follows: For each conjunct $x \in \Aut$ of $\psi$, let $\Aut = (\controls, q_0, \transrel, \finals)$, \emph{nondeterministically} select one state $q \in \finals$ and include $((\controls, \transrel), \{(q_0, q)\})$ into $\cE_0(x)$.
  
 %$\Aut$ $\left\{\Aut \mid x\in \Aut \text{ is a conjunct of }\psi \right\}$ for each variable $x$. 

Starting from $\cG_0$ we repeat the following procedure until %we reach some $i$ where 
$\cG_i$ becomes empty, i.e., a graph without edges.
 
We select (nondeterministically) a vertex $x$ of $\cG_i$ such that $x$ has no predecessors and has $k+1$ outgoing edges ($k\geq 0$) via edges $(x, (\Transducer, 0), y_0)$ and $(x, (\Transducer, j), y_j)$ with $j \in [k]$ in $\cG_i$. 
(Intuitively this corresponds to a relational constraint $x=T(y_0, \vec{y})$ for $\vec{y}=(y_1, \cdots, y_k)$.
Note that two different outgoing edges of $x$ in $\cG_i$ may correspond to the same variable.)
Suppose $\cE_i(x)=\{\Aut_1, \cdots, \Aut_n\}$, 
where $\Aut_j$ is a succinctly encoded NFA for each $j \in [n]$.
%$(\Sigma, Q_j, q_{0,j}, F_j, \delta_j)$ 
By the premise of the theorem, $\Pre_{\Transducer}(\Aut_j)$ is a recognisable relation and a representation of which, say $(\Aut^{(j')}_{j, 0}, \Aut^{(j')}_{j, 1}, \cdots, \Aut^{(j')}_{j, k})_{ j'  \in [m_j]}$, can be computed effectively.
Then $\cE_{i+1}(z)$ for $z \in  \{y_0,\cdots, y_k\}$ and $\cG_{i+1}$ are computed as follows:
\begin{enumerate}
\item For each $j \in [n]$, nondeterministically select a tuple $\left(\Aut^{(r_j)}_{j, 0}, \cdots, \Aut^{(r_j)}_{j, k}\right)$ for some $r_j \in [m_j]$.
%
\item For each $z \in \{y_0,\cdots, y_k\}$, let
\[
    \cE_{i+1}(z):= \cE_{i}(z) \cup \left\{\Aut^{(r_j)}_{j, \ell} \mid  j \in [n], \ell \in \{0\} \cup [k], z = y_{\ell} \right\}.
\]
[For each vertex $z'  {\notin} \{y_0,\cdots, y_k\}$, let $\cE_{i+1}(z') := \cE_i(z')$.]
%We set $\cE_{i+1}(x) = \emptyset$.
%
\item Let $\cG_{i+1}:= \cG_i \backslash \{(x, (\Transducer, j), y_j) \mid j \in \{0\} \cup [k]\}$.
\end{enumerate}
For each iteration, we update $i$ simply by  $i: = i+1$.
%\end{enumerate}
%
When exiting the loop, for each variable $x$, let $\cE(x)$ denote the set $\cE_i(x)$.

%\begin{example}
Let us use an example to help the reader understand the computation of $\cE_{i+1}$ from $\cE_i$.  Suppose that in $\cG_i$, to compute $\cE_{i+1}$, we select a variable $x$, which has no predecessors and three outgoing edges, say $(x, (\Transducer, 0), y)$, $(x, (\Transducer, 1), z)$, and $(x, (\Transducer, 2), y)$, where $y$ and $z$ are two distinct variables, moreover, $\cE_i(x) = \{\Aut_1, \Aut_2\}$. Let us also assume that  $\Pre_{\Transducer}(\Aut_1)$ (resp. $\Pre_{\Transducer}(\Aut_2)$) is represented by $(\Aut^{(j')}_{1, 0}, \Aut^{(j')}_{1, 1}, \Aut^{(j')}_{1, 2})_{ j'  \in [2]}$ (resp. $(\Aut^{(j')}_{2, 0}, \Aut^{(j')}_{2, 1}, \Aut^{(j')}_{2, 2})_{ j'  \in [3]}$). If for $j = 1$ (resp. $j=2$), $(\Aut^{(1)}_{1, 0}, \Aut^{(1)}_{1, 1}, \Aut^{(1)}_{1, 2})$  (resp. $\left(\Aut^{(3)}_{2, 0}, \Aut^{(3)}_{2, 1}, \Aut^{(3)}_{2, 2}\right)$)  is selected, then $\cE_{i+1}(y) = \cE_i(y) \cup \{\Aut^{(1)}_{1, 0}, \Aut^{(1)}_{1, 2}, \Aut^{(3)}_{2, 0} \cup \Aut^{(3)}_{2, 2}\}$ and $\cE_{i+1}(z) = \cE_{i}(z) \cup \{\Aut^{(1)}_{1, 1}, \Aut^{(3)}_{2, 1}\}$. 
%\end{example}

To decide the satisfiability of $\varphi \wedge \psi$, we have the following nondeterministic algorithm: first (nondeterministically) construct the sets $\cE(x)$ for $x \in \vars(\varphi \wedge \psi)$ as detailed above, then 
%guessing an accepting run of the product of NFAs 
checking the emptiness of the product of NFAs in $\cE(x)$ for each $x \in \vars(\varphi \wedge \psi)$.

\paragraph{Complexity analysis.} For each $i$, 
%\begin{itemize}
%\item 
let $M_i$ be the maximum number of elements in $\cE_i(x)$ for $x  \in \vars(\varphi \wedge \psi)$,
%\item 
and $N_i$ be the maximum size of the succinctly encoded NFAs in $\bigcup \limits_{x \in \vars(\varphi \wedge \psi)} \cE_i(x)$.
%\end{itemize}
Then we have $M_{i+1} \le M_i + (\rcdim(\varphi)+1)M_i = (\rcdim(\varphi)+2) M_i$. Moreover,  because each $T \in \transet$ occurring in $\varphi$ satisfies that $|T| \le |\varphi|$, we have $N_{i+1} \le f(|\varphi|, N_i)$. Therefore, we conclude that for each $x \in \vars(\varphi \wedge \psi)$, $\cE(x)$ contains at most $(\rcdim(\varphi)+2)^{\rcdep(\varphi)}$ elements and each succinctly encoded NFA in $\cE(x)$ is of size bounded by $f^{\langle \rcdep(\varphi) \rangle}(|\varphi|, |\psi|)$. 
Since each element $((Q, \delta), S)$ in $\cE(x)$ encodes an NFA of size $|Q|^{|S|} \le |Q|^{|Q|^2} \approx 2^{O(|Q|^2 \log |Q|)}$, it holds that the product automaton of NFAs in $\cE(x)$ is of size bounded by 
$$(\rcdim(\varphi)+2)^{\rcdep(\varphi)} 2^{O((f^{\langle \rcdep(\varphi) \rangle}(|\varphi|, |\psi|))^2 \log f^{\langle \rcdep(\varphi) \rangle}(|\varphi|, |\psi|) )}.$$
Since the nonemptiness of an NFA 
can be decided in nondeterministic logarithmic space in the size of the NFA, we deduce that the nonemptiness checking for $\cE(x)$ can be done in nondeterministic 
$$O(\rcdep(\varphi) (\log (\rcdim(\varphi)+2)) (f^{\langle \rcdep(\varphi) \rangle}(|\varphi|, |\psi|))^2 \log f^{\langle \rcdep(\varphi) \rangle}(|\varphi|, |\psi|)) \mbox{ space.}$$
%
Therefore, in overall, the space used by the aforementioned nondeterministic algorithm is 
$$O((\rcdim(\varphi)+2)^{\rcdep(\varphi)} (f^{\langle \rcdep(\varphi) \rangle}(|\varphi|, |\psi|))^2 \log f^{\langle \rcdep(\varphi) \rangle}(|\varphi|, |\psi|)).$$ 
\zhilin{Please check the complexity}
%Therefore, the satisfiability can be checked by a nondeterministic Turing machine with 
%$O((\rcdim(\varphi)+2)^{\rcdep(\varphi)} f^{\langle \rcdep(\varphi) \rangle}(|\varphi|, |\psi|))$ space.
\end{proof}

\section{Instantiations of the generic decision procedure}
 
\subsection{Two-way transducers}\label{sec-2way}

%Let $\Transducer$ be a 2PT with $k$ parameters $y_1,\cdots, y_k$ and $\Aut$ be an NFA. Then the \emph{preimage} of $\Aut$ w.r.t. $\Transducer$, denoted by $\Pre_\Transducer(\Aut)$, is the set of tuples $(w, w_1,\cdots, w_k)$ such that there is an accepting run of $\Transducer$ on $w$ producing an output $w' \in \Lang(\Aut)$, equipped with the parameters $w_1,\cdots, w_k$.


\begin{lemma}\label{lem-2pt}
Let $\Transducer$ be a 2PT and $\Aut$ be a succinctly encoded NFA $\Aut$. Then $\Pre_\Transducer(\Aut)$ is a recognisable relation. Moreover, a representation of $\Pre_\Transducer(\Aut)$, whose atom size is bounded by $2^{O(|\Transducer||\Aut|\log (|\Transducer||\Aut|))}$, can be computed effectively.
\end{lemma}

\begin{proof}
Assume a 2PT $\Transducer=(X, Q, q_0, F, \delta)$ with $X = \{x_1,\cdots, x_k\}$ and a succinctly encoded NFA $\Aut = ((Q', \delta'), S)$ with $S \subseteq Q' \times Q'$. %We first introduce some notations.

To compute $\Pre_\Transducer(\Aut)$, we use a notation $\cB_{\Transducer, \Aut, S_{x_1}, \cdots, S_{x_k}}$. 
%and $\Aut[S]$ defined below.

Suppose $S_{x_1}, \cdots, S_{x_k} \subseteq Q' \times Q'$ and $q \in F$. %\tl{$Q$ should be $Q'$?}
%
Then $\cB_{\Transducer, \Aut, S_{x_1}, \cdots, S_{x_k}, q}$ is the NFA constructed from $\Transducer$  by checking that there is an accepting run of $T$ on $w$, ending in the state $q$, and simulating an accepting run of $\Aut$ on the output of $\Transducer$. In particular, when the a transition of $\Transducer$ outputs $x_i$ (instead of a single letter), a pair of states $(q_1', q_2')$ will be nondeterministically selected from $S_{x_i}$, and the component of the state of $\cB_{\Transducer, \Aut, S_{x_1}, \cdots, S_{x_k}, q}$ corresponding to $\Aut_1$ will be updated from $q_1'$ to $q_2'$ to mimic a possible instantiation of $x_i$.  

%\tl{zhilin, I am not quite clear about the para, $y_1$ is a typo of $x_1$? I wrote a para above; please check}
%(instead of materialising the output), where $S_{x_1}$ is used to jump over $y_1$ when $x_1$ is the output of a transition of $\Transducer$, similarly for $S_{x_2}, \cdots, S_{x_k}$. 


More precisely, $\cB_{\Transducer, \Aut, S_{x_1}, \cdots, S_{x_k}, q}$ is computed in two steps:
\begin{enumerate} 
\item Construct a succinctly encoded 2NFA $\Aut'' = ((Q'', \delta''), S'')$, where $Q'' = Q \times Q'$, $S'' = \{((q_0, p), (q, p')) \mid (p, p') \in S\}$, and $\delta''$ comprises the tuples $((q_1, q'_1), a, dir, (q_2, q'_2))$ such that either there is $b \in \Sigma$ satisfying that $(q_1, a, dir, q_2, b) \in \delta$ and $(q'_1, b, q'_2) \in \delta'$, or there is $x_i \in X$ satisfying that $(q_1, a, dir, q_2, x_i) \in \delta$  and $(q'_1, q'_2) \in S_{x_i}$.
%
\item Transform $\Aut''$ into an equivalent succinctly encoded NFA $((Q''',\delta'''), S''')$, where $Q'''$ are vectors of mutually distinct states of $\Aut''$ (cf. Proposition~\ref{prop-2nfa-nfa}),  and $S' = \{(\vec{\rho}_1, \vec{\rho}_2) \mid  (p, p') \in S, \vec{\rho}_1[1] =(q_0, p), \vec{\rho}_2[|\vec{\rho}_2|] = (q, p') \}$.
%
%\item Define $\cB_{\Transducer, \Aut, S_{x_1}, \cdots, S_{x_k}, q}$ as $((Q''', \delta'''), S')$, where $S' = \{(\vec{\rho}_1, \vec{\rho}_2) \mid  (q'_1,q'_2) \in S, \vec{\rho}_1[1] =(q_0,q'_1), \vec{\rho}_2[|\vec{\rho}_2|] = (q, q'_2) \}$.
\end{enumerate} 
It is easy to see that  the size of $\cB_{\Transducer, \Aut, S_{x_1}, \cdots, S_{x_k}, q}$ is at most 
$2^{O(|T||\Aut| \log(|T||\Aut|))}$.   

%For $S \subseteq Q' \times Q'$, let $\Aut[S]$ denote the product of $\Aut(q'_1, \{q'_2\})$ for $(q'_1,q'_2) \in S$ (cf. Section~\ref{sec:prelim}, {Operations of NFAs.}). Since $S$ contains at most $|Q'|^2=|\Aut|^2$ many elements, the size of $\Aut[S]$ is bounded by $|\Aut|^{|\Aut|^2} \approx 2^{O(|\Aut|^2 \log |\Aut|)}$.


\paragraph{Claim.} For each tuple of strings $(w, w_1,\cdots, w_k)$, $(w, w_1,\cdots, w_k) \in \Pre_\Transducer(\Aut)$ iff there are $S_{x_1}, \cdots, S_{x_k} \subseteq Q' \times Q'$ and $q \in F$ such that $w \in \Lang(\cB_{\Transducer, S_{x_1}, \cdots, S_{x_k}, q})$ and $w_i \in \Lang(\Aut[S_{x_i}])$ for each $i \in [k]$, where $\Aut[S_{x_i}]=((Q', \delta'), S_{x_i})$.

\medskip


Therefore, $\Pre_\Transducer(\Aut)$ is a union of
\[\Lang(\cB_{\Transducer, S_{x_1}, \cdots, S_{x_k},q}) \times \Lang(\Aut[S_{x_1}]) \times \cdots  \times \Lang(\Aut[S_{x_k}]), \]
for $S_{x_1}, \cdots, S_{x_k} \subseteq Q' \times Q'$ and $q \in F$. 


We conclude that $\Pre_\Transducer(\Aut)$ is a recognisable relation and a representation of $\Pre_\Transducer(\Aut)$, whose atom size is bounded by $2^{O(|\Transducer||\Aut|\log (|\Transducer||\Aut|))}$, can be constructed effectively.
\end{proof}

From Lemma~\ref{lem-2pt} and Theorem~\ref{thm-generic-dec}, by some simple calculation, we deduce that the satisfiability of an $\straightline[\twpt]$ formula $\varphi \wedge \psi$ can be decided in 
%nondeterministic 
%$$O((\rcdim(\varphi)+2)^{\rcdep(\varphi)} (f^{\langle \rcdep(\varphi) \rangle}(|\varphi|, |\psi|))^2 \log f^{\langle \rcdep(\varphi) \rangle}(|\varphi|, |\psi|))$$ 
%space, where $f(j, k) = 2^{jk \log (j k)}$. 
nondeterministic $\tower(\rcdep(\varphi), O(|\varphi| |\psi| \log(|\varphi| |\psi|) ))$ space, thus in (deterministic) $\tower(\rcdep(\varphi), O(|\varphi| |\psi| \log(|\varphi| |\psi|) ))$ space, according to Savitch's theorem \cite{Savitch70}. Here $\tower(j, k)$ is a tower of $2$s of height $j$ with $k$ on top, formally, $\tower(1, k)= 2^k$ and $\tower(j+1, k) = 2^{\tower(j, k)}$. We conclude that the satisfiability of $\straightline[\twpt]$ formula $\varphi \wedge \psi$ can be decided in $\rcdep(\varphi)$-exponential space.
Moreover, we have a matching lower bound for the satisfiability of $\straightline[\twpt]$.
%
\begin{theorem}
Given an $\straightline[\twpt]$ formula $\varphi \wedge \psi$, its satisfiability can be decided in $\rcdep(\varphi)$-exponential space. Moreover,  for any $\expheight$, the satisfiability of $\straightline[\twpt]$ is $\expheight$-$\expspace$-hard.
\end{theorem}

The lower bound is proved as follows. \zhilin{@Matt, could you help put your lower bound proof here ?}

%The complexity bound is tight ...

\paragraph{Lower-bound.}

We give a matching lower bound for the satisfiability problem for $\strline[2PT]$. 
In particular, we show the problem is non-elementary.
More specifically, we show that, for any $\expheight$, the problem is $\expheight$-EXPSPACE-hard with $(\expheight+1)$ transducers. More precisely,
we provide a  reduction from a tiling problem that is hard for $\expheight$-EXPSPACE.
The reduction relies on the ability to manipulate large numbers that will be used to index the tiles in a solution to the tiling problem.
Similar encodings appear in the study of higher-order programs (e.g.~\cite{J01,CW07}).


%\input{two-way-lower.tex}

%======================================================================================================

\subsection{One-way transducers}


\begin{lemma}\label{lem-1pt}
Let $\Transducer$ be a 1PT and $\Aut$ be an NFA. Then $\Pre_\Transducer(\Aut)$ is a recognisable relation. Moreover, a representation of $\Pre_\Transducer(\Aut)$, whose atom size is bounded by $|\Transducer||\Aut|$, can be computed effectively.
\end{lemma}

Lemma~\ref{lem-1pt} can be proved in the same way as Lemma~\ref{lem-2pt}. The only difference is that the construction of $\cB_{\Transducer, \Aut, S_{x_1}, \ldots, S_{x_k}}$ is simpler and its size is at most $|\Transducer| |\Aut|$, since it is unnecessary to transform 2NFA to NFA.

From Lemma~\ref{lem-1pt} and Theorem~\ref{thm-generic-dec}, we deduce the following result.
%
\begin{corollary}
Given an $\straightline[\owpt]$ formula $\varphi \wedge \psi$, its satisfiability can be decided in $\expspace$. 
\end{corollary}

\begin{remark}
	instantiate the corollary by replace-all. 
\end{remark}

The complexity bound is tight since we can show that $\strline[\replaceall]$ is EXPSPACE-hard. We reduce from EXPSPACE-hard tiling problems.  

%\input{expspace-hardness.tex}

%To show the above result, we will give a constraint that represents a straight-line program which ``transforms'' an automaton into exponentially many different automata.
%These exponentially many automata will be used to check the vertical tiling relation for a tiling problem with an exponentially wide corridor.
%Since such tiling problems are EXPSPACE-hard, the result follows.

\begin{theorem}
	Satisfiability of $\strline[1PT]$, even in the single-letter case, is EXPSPACE-hard.
\end{theorem}


%
%\subsection{reversal-bounded transducers ?}
%
%\tl{include two-way non-parametric as well?}
