
\paragraph{Context-Aware Transductions}

Web pages are often constructed using templating systems such as Mustache.js or Google Closure.
Template HTML contains variables that are instantiated before the page is served.
A simple template is given in Figure~\ref{fig:closure}\ref{fig:closure-eg}.
A parametric transducer can instantiate the template variables with provided values easily enough, but, templating systems may also provide an ``auto-escape'' feature.
That is, the contents of the replaced variable will be ``escaped'' so that special characters (or sequences) which may allow code injection are replaced with safe alternatives to avoid attack.

For example, if \linkvar\ had the value \mintinline{js}{javascript: alert(1337)}, clicking the link in the instantiated template would run the JavaScript code \mintinline{js}{alert(1337)}.
To avoid this, Closure wraps URLs beginning with \mintinline{html}{javascript:} in single quotes.
Providing the value \mintinline{html}{<script>alert(1337)</script>} to \linktextvar\ would have a similar effect, but this time Closure replaces \texttt{<} with \texttt{\&lt;} and \texttt{>} with \texttt{\&gt;}.

\begin{figure}
\begin{center}
\begin{minipage}{.75\linewidth}
\begin{enumerate}[(a)]
\item \label{fig:closure-eg}
\begin{minted}{html}
<a href="{$li}"> {$txt} </a>
\end{minted}
\item \label{fig:closure-tagged}
\begin{minted}{html}
<a href="[URL]javascript: alert(1337)[LRU]">
    [HTML]<script>alert(1337)</script>[HTML] </a>
\end{minted}
\item \label{fig:closure-safe}
\begin{minted}{html}
<a href="'javascript: alert(1337)'">
    &lt;script&gt;alert(1337)&lt;/script&gt; </a>
\end{minted}
\end{enumerate}
\end{minipage}
\end{center}
\vspace{-3ex}
\caption{\label{fig:closure}A simple template (\ref{fig:closure-eg}) with two transduction steps (\ref{fig:closure-tagged}, \ref{fig:closure-safe}).}
\end{figure}

A key point is that the safe transduction depends on the context of the variable:
the escaping in a URL context is different to that in an HTML context.
We can model this using two transducers.
The first transducer instantiates the variables, but surrounds them with markers to indicate that the text inside needs to be escaped
(Figure~\ref{fig:closure}\ref{fig:closure-tagged});
we use \urlstarttag, \urlendtag, \htmlstarttag, and \htmlendtag.
Since transducers are a generalisation of finite automata, they are able to identify contexts using regular languages.
The second transducer then applies the appropriate safe transductions inside the markers.
For the URL context, values starting with \texttt{javascript:} will be quoted, while in HTML, instances of \texttt{<} and \texttt{>} are replaced by \texttt{\&lt;} and \texttt{\&gt;} respectively.
The result is shown in Figure~\ref{fig:closure}\ref{fig:closure-safe}.

\mat{
    One might worry that identifying text starting with \texttt{javascript:} means the transudcer needs to keep a buffer of the input string, leading to large transducers.
    In fact, we can avoid this by having the transducer non-deterministically guess that the following string will begin with \texttt{javascript:} and then verifying later that this was or was not the case.
    Let me know if you think i should put a footnote about this.
    It would also apply to contexts that need to see the text after the variable to confirm the (guessed) context is the right one.
}



