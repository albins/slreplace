%!TEX root = main.tex

\section{Instantiations of the generic decision procedure}\label{sec-instan}

In this section, we instantiate the generic decision procedure presented in the preceding section. In particular, the string functions of the assignments are modelled as parametric transducers. More precisely, each string function $f(x_1, \cdots, x_k)$ ($k\geq 1$) can be modelled by a parametric transducer $\Transducer$  
with $k-1$ parameters, and the size of $f$, $|f|$, is naturally defined by the size of $\Transducer$ (i.e., $|\Transducer|$). For the pre-image of an FA $\Aut$,  $\Pre_{R_f}(\Aut)$ is instantiated by $\Pre_\Transducer(\Aut)$, namely, the set of tuples $(w_1,\ldots, w_k)$ such that there is an accepting run of $\Transducer$ on $w_1$ with output $w'\in \Lang(\Aut)$ when equipped with the parameters $w_2,\ldots, w_k$. To apply Theorem~\ref{thm-generic-dec}, one only needs to verify the \prerec{} assumption. 
%While the latter trivially holds as we only consider assertions being regular constraints, the former is not trivial. 
For the rest of this section, we consider three classes of parametric transducers, viz. two-way transducers, one-way transducers, and Reversal-bounded two-way transducers. We shall show that in each case, the pre-image is a recognisable relation with various size bounds $\ell(|\Transducer|, |\Aut|)$. This would yield tight complexity bounds on the path feasibility problem for string manipulating programs $S$ when the string functions therein are given in parametric transducers.  



%the set of tuples $(w, w_1,\ldots, w_k)$ such that there is an accepting run of $\Transducer$ on $w$ with output $w'\in \Lang(\Aut)$ when equipped with the parameters $w_1,\ldots, w_k$. 
 
\subsection{Two-way transducers}\label{sec-2way}

%Let $\Transducer$ be a 2NPT with $k$ parameters $y_1,\cdots, y_k$ and $\Aut$ be an NFA. Then the \emph{preimage} of $\Aut$ w.r.t. $\Transducer$, denoted by $\Pre_\Transducer(\Aut)$, is the set of tuples $(w, w_1,\cdots, w_k)$ such that there is an accepting run of $\Transducer$ on $w$ producing an output $w' \in \Lang(\Aut)$, equipped with the parameters $w_1,\cdots, w_k$.


\begin{lemma}\label{lem-2pt}
Let $\Transducer$ be a \PPT{} and $\Aut$ be a conjunctive \FA{} $\Aut$. Then $\Pre_\Transducer(\Aut)$ is a recognisable relation. Moreover, a representation of $\Pre_\Transducer(\Aut)$, whose atom size is bounded by $2^{O(|\Transducer||\Aut|\log (|\Transducer||\Aut|))}$, can be computed effectively.
\end{lemma}

\begin{proof}
Assume a \PPT{} $\Transducer=(X, Q, q_0, F, \delta)$ with $X = \{x_1,\cdots, x_k\}$ and a conjunctive \FA{} $\Aut = ((Q', \delta'), S')$ with $S' \subseteq Q' \times Q'$. %We first introduce some notations.

To compute $\Pre_\Transducer(\Aut)$, we introduce an \FA{} $\cB_{\Transducer, \Aut, S_{x_1}, \cdots, S_{x_k}, q}$, %defined as follows. 
%and $\Aut[S]$ defined below.
%
where  $q \in F$, and  $S_{x_1}, \cdots, S_{x_k} \subseteq Q' \times Q'$.   
The \FA{} $\cB_{\Transducer, \Aut, S_{x_1}, \cdots, S_{x_k}, q}$ is constructed from $\Transducer$  by checking that there is an accepting run of $T$ on $w$, ending at the state $q$, and simulating an accepting run of $\Aut$ on the output of $\Transducer$. Therefore, each state of $\cB_{\Transducer, \Aut, S_{x_1}, \cdots, S_{x_k}, q}$ is of the form $(q,q') \in Q \times Q'$. 
%In particular, 
When a transition of $\Transducer$ outputs $x_i$ (instead of a constant string), a pair of states $(q_1', q_2')$ will be nondeterministically selected from $S_{x_i}$, and the second component of the state of $\cB_{\Transducer, \Aut, S_{x_1}, \cdots, S_{x_k}, q}$ will be updated from $q_1'$ to $q_2'$ to mimic a possible instantiation of $x_i$.  

%\tl{zhilin, I am not quite clear about the para, $y_1$ is a typo of $x_1$? I wrote a para above; please check}
%(instead of materialising the output), where $S_{x_1}$ is used to jump over $y_1$ when $x_1$ is the output of a transition of $\Transducer$, similarly for $S_{x_2}, \cdots, S_{x_k}$. 


More precisely, $\cB_{\Transducer, \Aut, S_{x_1}, \cdots, S_{x_k}, q}$ is computed in two steps:
\begin{enumerate} 
\item Construct a conjunctive \FFA{} $\Aut'' = ((Q'', \delta''), S'')$, where $Q'' = Q \times Q'$, $S'' = \{((q_0, p), (q, p')) \mid (p, p') \in S'\}$, and the transition relation $\delta''$ comprises the tuples $((q_1, q'_1), a, dir, (q_2, q'_2))$ such that either there is $w \in \Sigma^*$ satisfying that $(q_1, a, dir, q_2, w) \in \delta$ and $q'_1 \xrightarrow[\Aut]{w} q'_2$, or there is $x_i \in X$ satisfying that $(q_1, a, dir, q_2, x_i) \in \delta$  and $(q'_1, q'_2) \in S_{x_i}$.
%
\item Transform $\Aut''$ into an equivalent conjunctive \FA{} $((Q''',\delta'''), S''')$, where $Q'''$ are vectors of mutually distinct states of $\Aut''$ (cf. Proposition~\ref{prop-2nfa-nfa}),  and $S' = \{(\vec{\rho}_1, \vec{\rho}_2) \mid  (p, p') \in S, \vec{\rho}_1[1] =(q_0, p), \vec{\rho}_2[|\vec{\rho}_2|] = (q, p') \}$.
%
%\item Define $\cB_{\Transducer, \Aut, S_{x_1}, \cdots, S_{x_k}, q}$ as $((Q''', \delta'''), S')$, where $S' = \{(\vec{\rho}_1, \vec{\rho}_2) \mid  (q'_1,q'_2) \in S, \vec{\rho}_1[1] =(q_0,q'_1), \vec{\rho}_2[|\vec{\rho}_2|] = (q, q'_2) \}$.
\end{enumerate} 
It is easy to see that  the size of $\cB_{\Transducer, \Aut, S_{x_1}, \cdots, S_{x_k}, q}$ is at most 
$2^{O(|T||\Aut| \log(|T||\Aut|))}$.   

%For $S \subseteq Q' \times Q'$, let $\Aut[S]$ denote the product of $\Aut(q'_1, \{q'_2\})$ for $(q'_1,q'_2) \in S$ (cf. Section~\ref{sec:prelim}, {Operations of NFAs.}). Since $S$ contains at most $|Q'|^2=|\Aut|^2$ many elements, the size of $\Aut[S]$ is bounded by $|\Aut|^{|\Aut|^2} \approx 2^{O(|\Aut|^2 \log |\Aut|)}$.


\paragraph{Claim.} %For each tuple of strings $(w, w_1,\cdots, w_k)$, 
$(w, w_1,\cdots, w_k) \in \Pre_\Transducer(\Aut)$ iff there are $S_{x_1}, \cdots, S_{x_k} \subseteq Q' \times Q'$ and $q \in F$ such that $w \in \Lang(\cB_{\Transducer, S_{x_1}, \cdots, S_{x_k}, q})$ and $w_i \in \Lang(\Aut[S_{x_i}])$ for each $i \in [k]$, where $\Aut[S_{x_i}]=((Q', \delta'), S_{x_i})$.

\medskip


Therefore, $\Pre_\Transducer(\Aut)$ is equal to 
\[
\bigcup_{S_{x_1}, \cdots, S_{x_k} \subseteq Q' \times Q', q\in F} \Lang(\cB_{\Transducer, S_{x_1}, \cdots, S_{x_k},q}) \times \Lang(\Aut[S_{x_1}]) \times \cdots  \times \Lang(\Aut[S_{x_k}])\]
 


We conclude that $\Pre_\Transducer(\Aut)$ is a recognisable relation and a representation of $\Pre_\Transducer(\Aut)$, whose atom size is bounded by $2^{O(|\Transducer||\Aut|\log (|\Transducer||\Aut|))}$, can be constructed effectively.
\end{proof}

From Lemma~\ref{lem-2pt} and Theorem~\ref{thm-generic-dec}, by some simple calculation, we deduce that the satisfiability of an $\straightline[\twpt]$ formula $\varphi \wedge \psi$ can be decided in 
%nondeterministic 
%$$O((\rcdim(\varphi)+2)^{\rcdep(\varphi)} (f^{\langle \rcdep(\varphi) \rangle}(|\varphi|, |\psi|))^2 \log f^{\langle \rcdep(\varphi) \rangle}(|\varphi|, |\psi|))$$ 
%space, where $f(j, k) = 2^{jk \log (j k)}$. 
nondeterministic $\tower(\rcdep(\varphi), O(|\varphi| |\psi| \log(|\varphi| |\psi|) ))$ space, thus in (deterministic) $\tower(\rcdep(\varphi), O(|\varphi| |\psi| \log(|\varphi| |\psi|) ))$ space, according to Savitch's theorem \cite{Savitch70}. Here the function $\tower(j, k)$ is %a tower of $2$s of height $j$ with $k$ on top, formally, 
defined as: $\tower(1, k)= 2^k$ and $\tower(j+1, k) = 2^{\tower(j, k)}$. We conclude that the satisfiability of $\straightline[\twpt]$ formula $\varphi \wedge \psi$ can be decided in $\rcdep(\varphi)$-exponential space.
Moreover, we have a matching lower bound for the satisfiability of $\straightline[\twpt]$ described below.
%
\begin{theorem}
Given an $\straightline[\twpt]$ formula $\varphi \wedge \psi$, its satisfiability can be decided in $\rcdep(\varphi)$-exponential space. Moreover,  for any $\expheight$, one can construct an  $\straightline[\twpt]$ formula $\varphi \wedge \psi$ such that deciding the satisfiability of $\varphi \wedge \psi$  %$\straightline[\twpt]$ 
is $\expheight$-$\expspace$-hard.
\end{theorem}

\paragraph{Lower-bound.}

We show that, for any $\expheight$, the problem is $\expheight$-$\expspace$-hard with $(\expheight+1)$ transducers, via a reduction from a tiling problem that is hard for $\expheight$-$\expspace$.
For this we need to manipulate large numbers that will be used to index the tiles in a solution to the tiling problem.
Similar encodings appear in the study of higher-order programs (e.g.~\cite{J01,CW07}) except the machinery needed to enforce the encoding is quite different.
The complete encoding is given in 
\shortlong{the full version of this article}
          {Appendix~\ref{sec:two-way-lower}}.
We give an overview of the intuition here.

A \emph{tiling problem} consists of a finite set of tiles \tiles as well as horizontal and vertical tiling relations 
$\hrel, \vrel \subseteq \tiles \times \tiles$.
Given a tiling \emph{corridor} of a certain width, as well as initial and final tiles
$\inittile, \fintile \in \tiles$
the task is to find a tiling where 
\begin{itemize}
\item
    the first tile of the first row of the corridor is $\inittile$, 
\item
    the tile $\tile$ directly to the left of $\tile'$ in a row must have
    $\tup{\tile, \tile'} \in \hrel$,
\item
    the tile $\tile$ in the row above $\tile'$ in the same column must have
    $\tup{\tile, \tile'} \in \vrel$,
\item
    the last position of the last row must contain $\fintile$.
\end{itemize}
Tiling problems are intimately connected to computations of Turing machines as
each row can hold the tape contents in one configuration of a run.
Thus, the corridor width is equivalent to the space of a Turing machine.

The existence of a solution to a tiling problem of width $n$ can be reduced to checking whether a \FFT\ of size 
$\ap{\bigoh}{n}$ 
can output a specified symbol $\top$.
Equivalently, we could use a \FFA.
A solution to a tiling problem will be encoded as a word 
$t_{1,1} t_{1,2} \cdots t_{1,n} \numsep \cdots \numsep t_{m,1} t_{m,2} \cdots t_{m,n}$
where each row
$t_{i,1} t_{i,2} \cdots t_{i,n}$
is separated from the next row by $\numsep$.
The \FFT\ performs $n+1$ passes.
During the first pass it checks that the tiling begins with $\inittile$, ends with $\fintile$ and we have 
$\tup{t_{i,j}, t_{i,j+1}} \in \hrel$
for all
$1 \leq j < n$.
If the encoding passes this check, we need to verify that the vertical tiling relation $\vrel$ is met.
This is done in $n$ more passes, the $j$th of which verifies the $j$th column of the encoding.

To encode tiling problems of $n$-fold exponential width we chain $(n+1)$ \FFT.
We begin with two \FFT\ and a tiling problem of exponential width.
Intuitively, a row of the solution to a tiling problem could now be encoded with a sequence of $n$ binary bits preceding each tile.
That is
\[
    0\ldots00\ \tile_{1,1}\ %
    0\ldots01\ \tile_{1,2}\ %
    \cdots
    1\ldots11\ \tile_{1,2^n}\ %
    \numsep
    \cdots
    \numsep
    0\ldots00\ \tile_{m,1}\ %
    0\ldots01\ \tile_{m,2}\ %
    \cdots
    1\ldots11\ \tile_{m,2^n} \ .
\]
In fact, in the formal encoding, we will not use binary numbers, but instead use tiling problems whose solutions must have exponential length.
For the purposes of the intuitive exposition, we will use binary numbers as the intention is clearer.

Given such an encoding, the first \FFT\ checks the solution in a similar manner to the width $n$ problem.
To cope with the large corridor width, it will output ``queries'' to the second \FFT.
These queries check whether one binary number is equal to the next, or is the increment.
Now, the first \FFT\ can, for example, non-deterministically guess that one tile is in the same column as another and use queries to verify this guess.
In this way it becomes able to verify a tiling over an exponentially wide corridor.

To increase the corridor width by another exponential, we need another \FFT.
To reach doubly-exponentially large numbers, we need to precede each tile with a binary sequence of exponential length.
For this we precede each bit with another binary sequence, this time of length $n$.
Thus, we have two sets of binary digits $0,1$ and $0', 1'$, and, if $n = 2$ a row would take the following form
\[
    (0'0') 0 (0'1') 0 (1'0') 0 (1'1') 0\ \tile_1\ %
    (0'0') 0 (0'1') 0 (1'0') 0 (1'1') 1\ \tile_2\ % 
    \ldots 
\]
where parenthesis are shown for clarity only.
To check a given tiling, the first \FFT\ outputs queries to the second.
To be able to check exponentially long binary numbers, the second \FFT\ outputs queries to the third \FFT.
This process can be iterated so that using $(n+1)$ \FFT, we can search for a solution of a tiling problem over an $n$-fold exponentially wide corridor.



%======================================================================================================

\subsection{One-way transducers}


\begin{lemma}\label{lem-1pt}
Let $\Transducer$ be a 1PT and $\Aut$ be a conjunctive NFA. Then $\Pre_\Transducer(\Aut)$ is a recognisable relation. Moreover, a representation of $\Pre_\Transducer(\Aut)$, whose atom size is bounded by $|\Transducer||\Aut|$, can be computed effectively.
\end{lemma}

Lemma~\ref{lem-1pt} can be proved in the same way as Lemma~\ref{lem-2pt}. The only difference is that the construction of $\cB_{\Transducer, \Aut, S_{x_1}, \ldots, S_{x_k}, q}$ is simpler and its size is at most $|\Transducer| |\Aut|$, since the transformation from  2NFA to NFA is not needed.

From Lemma~\ref{lem-1pt} and Theorem~\ref{thm-generic-dec}, we deduce the following result.
%
\begin{theorem} \label{thm-1pt}
%Given an $\straightline[\owpt]$ formula $\varphi \wedge \psi$, 
The satisfiability problem of $\straightline[\owpt]$ is $\expspace$-complete. 
\end{theorem}

The lower bound in Theorem~\ref{thm-1pt} is deduced from the result in \cite{LB16} that the satisfiability of straight-line string constraints with concatenation and one-way transducers, which are both captured by 1PT, is $\expspace$-complete.

\subsection{Reversal-bounded two-way transducers}

Let $k \in \Nat$. A 2PT $\Transducer$ is said  to be $k$-reversal bounded if in every run of $\Transducer$ on input strings, the reading head is reversed for at most $k$ times. We use  RB2PT$_k$ to denote the class of $k$-reversal bounded 2PTs. The reverse function can be captured by a reversal $1$-bounded 2PT.
Note that the class of $0$-reversal bounded 2PTs is precisely the class of 1PTs.

\begin{lemma}\label{lem-rb-2pt}
Let $k \in \Nat$, $\Transducer$ be a RB2PT$_k$, and $\Aut$ be a conjunctive NFA. Then $\Pre_\Transducer(\Aut)$ is a recognisable relation. Moreover, a representation of $\Pre_\Transducer(\Aut)$, whose atom size is bounded by $(|\Transducer||\Aut|)^k$ \tl{k+1?}, can be computed effectively.
\end{lemma}

The proof of Lemma~\ref{lem-rb-2pt} is the same as Lemma~\ref{lem-2pt}. The only difference is that the size of $\cB_{\Transducer, \Aut, S_{x_1}, \ldots, S_{x_k}, q}$ is at most $(|\Transducer| |\Aut|)^k$, since $\Transducer$ is reversal $k$-bounded.

From Lemma~\ref{lem-rb-2pt} and Theorem~\ref{thm-generic-dec}, we deduce the following result.
%
\begin{theorem} \label{thm-rb-2pt}
%Given an $\straightline[\owpt]$ formula $\varphi \wedge \psi$, 
For each constant $k \in \Nat$, the satisfiability problem of $\straightline[\rbtwpt_k]$ is $\expspace$-complete. 
\end{theorem}
\tl{I add constant as this is a parameterised complexity result}

The $\expspace$-hardness in Theorem~\ref{thm-rb-2pt} follows from Theorem~\ref{thm-1pt}.

%\input{expspace-hardness.tex}

%To show the above result, we will give a constraint that represents a straight-line program which ``transforms'' an automaton into exponentially many different automata.
%These exponentially many automata will be used to check the vertical tiling relation for a tiling problem with an exponentially wide corridor.
%Since such tiling problems are $\expspace$-hard, the result follows.

%\begin{theorem}\label{thm-1pt}
%	Satisfiability of $\strline[1PT]$, even in the single-letter case, is $\expspace$-hard.
%\end{theorem}


%
%\subsection{reversal-bounded transducers ?}
%
%\tl{include two-way non-parametric as well?}
